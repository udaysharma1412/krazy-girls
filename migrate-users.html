<!DOCTYPE html>
<html>
<head>
    <title>Migrate Users to MongoDB</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .user { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .migrate-btn { background: #27ae60; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }
        .clear-btn { background: #e74c3c; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 10px; margin: 5px 0; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; padding: 10px; margin: 5px 0; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üöÄ Migrate LocalStorage Users to MongoDB</h1>
    
    <div class="section">
        <h2>üìä Current Status</h2>
        <div id="status"></div>
        <button class="migrate-btn" onclick="checkStatus()">üîÑ Check Status</button>
    </div>
    
    <div class="section">
        <h2>üë• LocalStorage Users</h2>
        <div id="localStorageUsers"></div>
        <button class="migrate-btn" onclick="migrateAllUsers()">üöÄ Migrate All Users</button>
        <button class="clear-btn" onclick="clearLocalStorage()">üóëÔ∏è Clear LocalStorage</button>
    </div>
    
    <div class="section">
        <h2>üóÑÔ∏è MongoDB Users</h2>
        <div id="mongoUsers">
            <button class="migrate-btn" onclick="fetchMongoUsers()">üìä Load MongoDB Users</button>
        </div>
    </div>
    
    <div class="section">
        <h2>üìà Migration Results</h2>
        <div id="results"></div>
    </div>

    <script>
        function checkStatus() {
            const statusDiv = document.getElementById('status');
            
            // Check localStorage users
            const usersKey = 'krazygirls_users';
            const usersData = localStorage.getItem(usersKey);
            const localStorageUsers = usersData ? JSON.parse(usersData) : [];
            
            // Check current user
            const currentUserKey = 'krazygirls_current_user';
            const currentUserData = localStorage.getItem(currentUserKey);
            const currentUser = currentUserData ? JSON.parse(currentUserData) : null;
            
            let html = '<h3>üìä Storage Status:</h3>';
            html += '<p><strong>LocalStorage Users:</strong> ' + localStorageUsers.length + '</p>';
            html += '<p><strong>Current User:</strong> ' + (currentUser ? currentUser.name : 'None') + '</p>';
            html += '<p><strong>Current User Source:</strong> ' + (currentUser && currentUser.mongodbId ? 'MongoDB' : 'LocalStorage') + '</p>';
            
            statusDiv.innerHTML = html;
        }
        
        function showLocalStorageUsers() {
            const usersDiv = document.getElementById('localStorageUsers');
            const usersKey = 'krazygirls_users';
            const usersData = localStorage.getItem(usersKey);
            const users = usersData ? JSON.parse(usersData) : [];
            
            if (users.length === 0) {
                usersDiv.innerHTML = '<p>No users in localStorage</p>';
                return;
            }
            
            let html = '<h3>üë• ' + users.length + ' Users in LocalStorage:</h3>';
            users.forEach(function(user, index) {
                html += '<div class="user">';
                html += '<strong>' + (index + 1) + '. ' + user.name + '</strong><br>';
                html += 'Email: ' + user.email + '<br>';
                html += 'Phone: ' + user.phone + '<br>';
                html += 'Created: ' + (user.createdAt || 'Unknown') + '<br>';
                html += 'MongoDB ID: ' + (user.mongodbId || 'Not synced') + '</div>';
            });
            
            usersDiv.innerHTML = html;
        }
        
        async function migrateAllUsers() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üöÄ Migrating users...</h3>';
            
            const usersKey = 'krazygirls_users';
            const usersData = localStorage.getItem(usersKey);
            const users = usersData ? JSON.parse(usersData) : [];
            
            if (users.length === 0) {
                resultsDiv.innerHTML = '<div class="warning">No users to migrate</div>';
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            let resultsHTML = '<h3>üìä Migration Results:</h3>';
            
            for (let i = 0; i < users.length; i++) {
                const user = users[i];
                try {
                    const response = await fetch('http://localhost:5003/api/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: user.name,
                            email: user.email,
                            phone: user.phone,
                            password: 'migrated123'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                        resultsHTML += '<div class="success">‚úÖ ' + user.name + ' (' + user.email + ') - Migrated successfully</div>';
                    } else {
                        errorCount++;
                        resultsHTML += '<div class="error">‚ùå ' + user.name + ' (' + user.email + ') - Failed: ' + result.message + '</div>';
                    }
                } catch (error) {
                    errorCount++;
                    resultsHTML += '<div class="error">‚ùå ' + user.name + ' (' + user.email + ') - Error: ' + error.message + '</div>';
                }
            }
            
            resultsHTML += '<h3>üìà Summary: ' + successCount + ' successful, ' + errorCount + ' failed</h3>';
            resultsDiv.innerHTML = resultsHTML;
            
            // Refresh displays
            setTimeout(function() {
                checkStatus();
                showLocalStorageUsers();
                fetchMongoUsers();
            }, 2000);
        }
        
        async function fetchMongoUsers() {
            const mongoDiv = document.getElementById('mongoUsers');
            mongoDiv.innerHTML = '<p>Loading...</p>';
            
            try {
                const response = await fetch('http://localhost:5003/api/users');
                const result = await response.json();
                
                if (result.success) {
                    let html = '<h3>üóÑÔ∏è ' + result.count + ' Users in MongoDB:</h3>';
                    result.users.forEach(function(user, index) {
                        html += '<div class="user">';
                        html += '<strong>' + (index + 1) + '. ' + user.name + '</strong><br>';
                        html += 'Email: ' + user.email + '<br>';
                        html += 'Phone: ' + user.phone + '<br>';
                        html += 'Created: ' + new Date(user.createdAt).toLocaleString() + '<br>';
                        html += 'Welcome Email: ' + (user.welcomeEmailSent ? 'Sent ‚úÖ' : 'Not sent ‚ùå') + '</div>';
                    });
                    mongoDiv.innerHTML = html;
                } else {
                    mongoDiv.innerHTML = '<div class="error">‚ùå Failed to fetch users</div>';
                }
            } catch (error) {
                mongoDiv.innerHTML = '<div class="error">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        function clearLocalStorage() {
            if (confirm('Are you sure you want to delete all users from localStorage?')) {
                localStorage.removeItem('krazygirls_users');
                localStorage.removeItem('krazygirls_current_user');
                checkStatus();
                showLocalStorageUsers();
                document.getElementById('results').innerHTML = '<div class="success">‚úÖ LocalStorage cleared</div>';
            }
        }
        
        // Initialize on load
        window.onload = function() {
            checkStatus();
            showLocalStorageUsers();
        };
    </script>
</body>
</html>
